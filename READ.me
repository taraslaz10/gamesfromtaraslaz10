I wrote this code about 4 years ago, so code-style isn't perfect.
